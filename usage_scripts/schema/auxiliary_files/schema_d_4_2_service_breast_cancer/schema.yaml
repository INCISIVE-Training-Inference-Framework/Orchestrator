apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: d-4-2-service-breast-cancer-mg-
spec:
  serviceAccountName: argo-workflow
  imagePullSecrets:
  - name: incisive-azurecrio-secret
  ttlStrategy:
    secondsAfterCompletion: 100
    secondsAfterSuccess: 100
    secondsAfterFailure: 1200
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  # artifactGC:
  #   strategy: OnWorkflowDeletion
  onExit: exit-handler
  entrypoint: main
  volumes:
  - name: input-elements
    emptyDir: {}
  - name: ai-elements
    emptyDir: {}
  - name: output-elements
    emptyDir: {}
  - name: raw-platform-vars
    configMap:
      name: "{{workflow.parameters.aiEngine_plaformVarsConfigMapName}}"
  - name: platform-vars
    emptyDir: {}

  # Global workflow arguments
  arguments:
    parameters:
    - name: platform_centralNodeLabelKey
    - name: platform_centralNodeLabelValue
    - name: platform_maasApiHostname
    - name: platform_orchestratorApiHostname
    - name: platform_processorResourceManagerVersion
    - name: platform_processorResourceManagerCallbackUrl
    - name: aiEngine_plaformVarsConfigMapName
    - name: aiEngine_plaformVarsInputElements
    - name: aiEngine_plaformVarsInputDataInference
    - name: aiEngine_plaformVarsInputAIElements
    - name: aiEngine_plaformVarsInputUserVars
    - name: aiEngine_plaformVarsInputModel
    - name: aiEngine_plaformVarsOutputElements
    - name: aiEngine_plaformVarsOutputInferenceResults
    - name: aiEngine_plaformVarsApiPingUrl
    - name: aiEngine_plaformVarsApiRunUrl
    - name: aiEngine_plaformVarsApiEndUrl
    - name: execution_id
    - name: execution_segmentation-container-name
    - name: execution_segmentation-container-version
    - name: execution_segmentation-container-version-max-iteration-time
    - name: execution_segmentation-ai-model
    - name: execution_segmentation-prm-api-host
    - name: execution_segmentation-plaform-vars-api-host
    - name: execution_localization-container-name
    - name: execution_localization-container-version
    - name: execution_localization-container-version-max-iteration-time
    - name: execution_localization-ai-model
    - name: execution_localization-prm-api-host
    - name: execution_localization-plaform-vars-api-host
    - name: execution_prioritization-container-name
    - name: execution_prioritization-container-version
    - name: execution_prioritization-container-version-max-iteration-time
    - name: execution_prioritization-ai-model
    - name: execution_prioritization-prm-api-host
    - name: execution_prioritization-plaform-vars-api-host
    - name: execution_birads-classification-xai-container-name
    - name: execution_birads-classification-xai-container-version
    - name: execution_birads-classification-xai-container-version-max-iteration-time
    - name: execution_birads-classification-xai-ai-model
    - name: execution_birads-classification-xai-prm-api-host
    - name: execution_birads-classification-xai-plaform-vars-api-host
    - name: execution_density-classification-xai-container-name
    - name: execution_density-classification-xai-container-version
    - name: execution_density-classification-xai-container-version-max-iteration-time
    - name: execution_density-classification-xai-ai-model
    - name: execution_density-classification-xai-prm-api-host
    - name: execution_density-classification-xai-plaform-vars-api-host
    - name: execution_medical-report-generation-container-name
    - name: execution_medical-report-generation-container-version
    - name: execution_medical-report-generation-container-version-max-iteration-time
    - name: execution_medical-report-generation-prm-api-host
    - name: execution_medical-report-generation-plaform-vars-api-host

  templates:
    - name: main
      steps:
      - - name: initial-ai-engines
          template: ai-engine-template
          arguments:
            parameters:
            - name: descriptor
              value: "{{item}}"
            - name: prm-api-host
              value: "{{ workflow.parameters.execution_{{item}}-prm-api-host }}"
            - name: plaform-vars-api-host
              value: "{{ workflow.parameters.execution_{{item}}-plaform-vars-api-host }}"
            - name: container-name
              value: "{{ workflow.parameters.execution_{{item}}-container-name }}"
            - name: container-version
              value: "{{ workflow.parameters.execution_{{item}}-container-version }}"
            - name: max-iteration-time
              value: "{{ workflow.parameters.execution_{{item}}-container-version-max-iteration-time }}"
            - name: ai-model
              value: "{{ workflow.parameters.execution_{{item}}-ai-model}}"
            - name: ai-model-download-resume-retries
              value: "{{ workflow.parameters.execution_{{item}}-ai-model-download-resume-retries }}"
          withItems:
          - "segmentation"
          - "localization"
          - "prioritization"
          - "birads-classification-xai"
          - "density-classification-xai"
      - - name: medical-report-generation
          template: medical-report-generation-template
      - - name: finalization
          template: finalization-template
              
    - name: ai-engine-template
      nodeSelector: {"{{workflow.parameters.platform_centralNodeLabelKey}}": "{{workflow.parameters.platform_centralNodeLabelValue}}"}
      retryStrategy:
        limit: "2"
        retryPolicy: "Always"
      inputs:
        parameters:
        - name: descriptor
        - name: prm-api-host
        - name: plaform-vars-api-host
        - name: container-name
        - name: container-version
        - name: max-iteration-time
        - name: ai-model
        - name: ai-model-download-resume-retries
      outputs:
        parameters:
        - name: error-message
          valueFrom:
            default: "Unexpected error"
            path: /usr/application/error_message.txt
          globalName: main-error-message
        artifacts:
        - name: output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/{{inputs.parameters.descriptor}}"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "{{inputs.parameters.descriptor}}-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization
          path: "{{workflow.parameters.aiEngine_plaformVarsOutputInferenceResults}}"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-{{inputs.parameters.descriptor}}-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
      initContainers:
      - name: config-changer
        image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
        args: ["{\"actions\":[{\"name\":\"change_api_host_and_port\",\"read_file_path\":\"/platform_vars.json\",\"write_file_path\":\"/tmp/config_changer/platform_vars.json\",\"api_host_and_port\":\"{{inputs.parameters.plaform-vars-api-host}}\"}]}"]
        volumeMounts:
        - name: raw-platform-vars
          mountPath: /platform_vars.json
          subPath: platform_vars.json  
        - name: platform-vars
          mountPath: /tmp/config_changer
      containerSet:
        volumeMounts:
        - name: input-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsInputElements}}"
        - name: ai-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsInputAIElements}}"
        - name: output-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsOutputElements}}"
        - name: platform-vars
          mountPath: /platform_vars.json
          subPath: platform_vars.json
        containers:
          - name: main
            image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
            resources:
              requests:
                cpu: 250m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 256Mi
            args: ["{\"actions\":[{\"name\":\"update_to_running\",\"update_status_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/update_to_running/\"},{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}\"},{\"name\":\"download_external_data\",\"external_data_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/download_external_data/\",\"output_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}\"},{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputAIElements}}\"},{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputModel}}\"},{\"name\":\"download_user_vars\",\"user_vars_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/download_user_vars/?descriptor={{inputs.parameters.descriptor}}\",\"output_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputUserVars}}\"},{\"name\":\"download_ai_model\",\"ai_model_url\":\"http://{{workflow.parameters.platform_maasApiHostname}}/api/ai_models/{{inputs.parameters.ai-model}}/download_contents/\",\"output_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputModel}}\", \"download_resume_retries\": {input.parameters.ai-model-download-resume-retries}},{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsOutputInferenceResults}}\"},{\"name\":\"run_ai_engine\",\"use_case\":\"inferencing_from_pretrained_model\",\"max_iteration_time\":{{inputs.parameters.max-iteration-time}},\"max_initialization_time\":600,\"client_host\":\"{{inputs.parameters.plaform-vars-api-host}}\",\"server_host\":\"{{inputs.parameters.prm-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"run_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiRunUrl}}\",\"callback_url\":\"{{workflow.parameters.platform_processorResourceManagerCallbackUrl}}\"},{\"name\":\"end_ai_engine\",\"max_finalization_time\":30,\"max_finalization_retries\":4,\"client_host\":\"{{workflow.parameters.execution_segmentation-plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"end_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiEndUrl}}\"}]}", "--failure-actions", "{\"actions\":[{\"name\":\"ping_ai_engine\",\"max_initialization_time\":30,\"client_host\":\"{{inputs.parameters.plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\"},{\"name\":\"end_ai_engine\",\"max_finalization_time\":30,\"max_finalization_retries\":4,\"client_host\":\"{{inputs.parameters.plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"end_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiEndUrl}}\"}]}"]
          - name: main-ai-engine
            image: "incisive.azurecr.io/{{inputs.parameters.container-name}}:{{inputs.parameters.container-version}}"
            resources:
              requests:
                cpu: 250m
                memory: 2560Mi
              limits:
                cpu: 2000m
                memory: 2560Mi
        
    - name: medical-report-generation-template
      nodeSelector: {"{{workflow.parameters.platform_centralNodeLabelKey}}": "{{workflow.parameters.platform_centralNodeLabelValue}}"}
      retryStrategy:
        limit: "2"
        retryPolicy: "Always"
      inputs:
        artifacts:
        - name: segmentation-output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/segmentation"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "segmentation-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: localization-output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/localization"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "localization-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: prioritization-output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/prioritization"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "prioritization-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: birads-classification-xai-output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/birads-classification-xai"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "birads-classification-xai-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: density-classification-xai-output
          path: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}/density-classification-xai"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "density-classification-xai-output-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
      outputs:
        parameters:
        - name: error-message
          valueFrom:
            default: "Unexpected error"
            path: /usr/application/error_message.txt
          globalName: main-error-message
        artifacts:
        - name: visualization
          path: "{{workflow.parameters.aiEngine_plaformVarsOutputInferenceResults}}"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-medical-report-generation-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
      initContainers:
      - name: issue-solver  # solves very strange issue with volumes when mounting input artifacts
        image: "busybox:1.36"
        command: [/bin/sh, -c]
        args: ["rm -r /tmp/config_changer/platform_vars.json"]
        volumeMounts:
        - name: platform-vars
          mountPath: /tmp/config_changer
      - name: config-changer
        image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
        args: ["{\"actions\":[{\"name\":\"change_api_host_and_port\",\"read_file_path\":\"/platform_vars.json\",\"write_file_path\":\"/tmp/config_changer/platform_vars.json\",\"api_host_and_port\":\"{{workflow.parameters.execution_medical-report-generation-plaform-vars-api-host}}\"}]}"]
        volumeMounts:
        - name: raw-platform-vars
          mountPath: /platform_vars.json
          subPath: platform_vars.json  
        - name: platform-vars
          mountPath: /tmp/config_changer
      containerSet:
        volumeMounts:
        - name: input-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsInputDataInference}}"
        - name: ai-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsInputAIElements}}"
        - name: output-elements
          mountPath: "{{workflow.parameters.aiEngine_plaformVarsOutputElements}}"
        - name: platform-vars
          mountPath: /platform_vars.json
          subPath: platform_vars.json
        containers:
          - name: main
            image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
            resources:
              requests:
                cpu: 250m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 256Mi
            args: ["{\"actions\":[{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputAIElements}}\"},{\"name\":\"download_user_vars\",\"user_vars_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/download_user_vars/?descriptor=medical-report-generation\",\"output_path\":\"{{workflow.parameters.aiEngine_plaformVarsInputUserVars}}\"},{\"name\":\"create_directory\",\"directory_path\":\"{{workflow.parameters.aiEngine_plaformVarsOutputInferenceResults}}\"},{\"name\":\"run_ai_engine\",\"use_case\":\"inferencing_from_pretrained_model\",\"max_iteration_time\":{{workflow.parameters.execution_medical-report-generation-max-iteration-time}},\"max_initialization_time\":600,\"client_host\":\"{{workflow.parameters.execution_medical-report-generation-plaform-vars-api-host}}\",\"server_host\":\"{{workflow.parameters.execution_medical-report-generation-prm-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"run_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiRunUrl}}\",\"callback_url\":\"{{workflow.parameters.platform_processorResourceManagerCallbackUrl}}\"},{\"name\":\"end_ai_engine\",\"max_finalization_time\":30,\"max_finalization_retries\":4,\"client_host\":\"{{workflow.parameters.execution_medical-report-generation-plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"end_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiEndUrl}}\"}]}", "--failure-actions", "{\"actions\":[{\"name\":\"ping_ai_engine\",\"max_initialization_time\":30,\"client_host\":\"{{workflow.parameters.execution_medical-report-generation-plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",},{\"name\":\"end_ai_engine\",\"max_finalization_time\":30,\"max_finalization_retries\":4,\"client_host\":\"{{workflow.parameters.execution_medical-report-generation-plaform-vars-api-host}}\",\"ping_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiPingUrl}}\",\"end_url\":\"{{workflow.parameters.aiEngine_plaformVarsApiEndUrl}}\"}]}"]
          - name: main-ai-engine
            image: "incisive.azurecr.io/{{workflow.parameters.execution_medical-report-generation-container-name}}:{{workflow.parameters.execution_medical-report-generation-container-version}}"
            resources:
              requests:
                cpu: 250m
                memory: 2560Mi
              limits:
                cpu: 2000m
                memory: 2560Mi

    - name: finalization-template
      nodeSelector: {"{{workflow.parameters.platform_centralNodeLabelKey}}": "{{workflow.parameters.platform_centralNodeLabelValue}}"}
      retryStrategy:
        limit: "2"
        retryPolicy: "Always"
      inputs:
        artifacts:
        - name: visualization-segmentation
          path: "/tmp/output_elements/segmentation/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-segmentation-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization-localization
          path: "/tmp/output_elements/localization/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-localization-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization-prioritization
          path: "/tmp/output_elements/prioritization/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-prioritization-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization-birads-classification-xai
          path: "/tmp/output_elements/birads-classification-xai/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-birads-classification-xai-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization-density-classification-xai
          path: "/tmp/output_elements/density-classification-xai/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-density-classification-xai-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
        - name: visualization-medical-report-generation
          path: "/tmp/output_elements/medical-report-generation/"
          azure:
            endpoint: https://incisivesa.blob.core.windows.net
            container: d-4-2-service-breast-cancer
            blob: "visualization-medical-report-generation-{{workflow.creationTimestamp.RFC3339}}"
            accountKeySecret:
              name: incisive-azure-storage-credentials
              key: account-access-key
      outputs:
        parameters:
        - name: error-message
          valueFrom:
            default: "Unexpected error"
            path: /usr/application/error_message.txt
          globalName: main-error-message
      container:
        image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 256Mi
        args: ["{\"actions\":[{\"name\":\"update_to_succeeded\",\"update_status_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/update_to_succeeded/\",\"upload_ai_model\":false,\"upload_evaluation_metrics\":false,\"upload_generic_file\":true,\"generic_file_upload_url\":\"http://{{workflow.parameters.platform_maasApiHostname}}/api/generic_files/\",\"generic_file_delete_url\":\"http://{{workflow.parameters.platform_maasApiHostname}}/api/generic_files/\",\"generic_file_upload_path\":\"/tmp/output_elements/\",\"generic_file_upload_metadata\":{\"name\":\"InferenceResultsfromExecution{{workflow.parameters.execution_id}}\"}}]}"]
        
    - name: exit-handler
      steps:
      - - name: notify-failure
          when: "{{workflow.status}} != Succeeded"
          template: exit-handler-communicate-error

    - name: exit-handler-communicate-error
      inputs:
        parameters:
        - name: error-message
          value: "{{workflow.outputs.parameters.main-error-message}}"
      nodeSelector: {"{{workflow.parameters.platform_centralNodeLabelKey}}": "{{workflow.parameters.platform_centralNodeLabelValue}}"}
      container:
        image: "incisive.azurecr.io/processor-resource-manager:{{workflow.parameters.platform_processorResourceManagerVersion}}"
        args: ["{\"actions\":[{\"name\":\"update_to_failed\", \"message\":\"{{inputs.parameters.error-message}}\", \"update_status_url\":\"http://{{workflow.parameters.platform_orchestratorApiHostname}}/api/executions/{{workflow.parameters.execution_id}}/update_to_failed/\"}]}"]

